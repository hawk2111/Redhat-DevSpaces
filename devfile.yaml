schemaVersion: 2.2.0
metadata:
  name: python-312-reqs
  version: 1.2.0
  displayName: Python 3.12 + requirements.txt (Dev Spaces)
  description: OpenShift Dev Spaces with Python 3.12.12; deps installed from requirements.txt

projects: []

components:
  - name: tools
    container:
      image: python:3.12.12-slim
      memoryLimit: 8Gi
      cpuRequest: "500m"
      cpuLimit: "4"
      mountSources: true
      sourceMapping: /projects
      env:
        - name: PIP_DISABLE_PIP_VERSION_CHECK
          value: "1"
        - name: PIP_NO_CACHE_DIR
          value: "1"
        - name: VIRTUAL_ENV
          value: /projects/.venv
        - name: PATH
          value: /projects/.venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      volumeMounts:
        - name: pip-cache
          path: /root/.cache/pip
      command: ["sh"]
      args: ["-c", "while sleep 1000; do :; done"]

  - name: pip-cache
    volume:
      size: 2Gi

commands:
  - id: create-venv-and-install
    exec:
      component: tools
      workingDir: /projects
      label: "Create venv & install from requirements.txt"
      commandLine: |
        bash -lc '
          set -e
          python -m venv /projects/.venv
          . /projects/.venv/bin/activate
          python -m pip install --upgrade pip wheel setuptools
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "requirements.txt not found at /projects â€” skipping dependency install."
          fi
          if ! grep -q "/projects/.venv/bin/activate" ~/.bashrc; then
            echo ". /projects/.venv/bin/activate" >> ~/.bashrc
          fi
        '
      group:
        kind: build
        isDefault: true

  - id: sync-deps
    exec:
      component: tools
      workingDir: /projects
      label: "Re-install deps from requirements.txt"
      commandLine: |
        bash -lc '
          set -e
          . /projects/.venv/bin/activate
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "requirements.txt not found."
          fi
        '
      group:
        kind: run

  - id: python-version
    exec:
      component: tools
      workingDir: /projects
      label: "Show Python & package versions"
      commandLine: |
        bash -lc '
          . /projects/.venv/bin/activate
          python --version
        '
      group:
        kind: run

events:
  postStart:
    - create-venv-and-install
